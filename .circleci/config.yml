version: 2.1

parameters:
  slack-mentions:
    type: string
    default: 'S01JP5A3ACQ'
  only_for_branches:
    type: string
    default: 'main'

orbs:
  slack: circleci/slack@3.4.2

executors:
  brew-exec:
    docker:
      - image: homebrew/brew:latest

jobs:
  audit:
    executor: brew-exec
    steps:
      - checkout
      - run: make lint-cli
  update:
    executor: brew-exec
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "6a:1b:3f:38:f4:02:07:5a:fa:52:fc:20:f6:46:8c:75"
      - run: make update-cli-version
  test:
    executor: brew-exec
    steps:
      - checkout
      - run: make install-cli-from-source
      - run: make test

workflows:
  version: 2
  audit-formula:
    jobs:
      - audit
      - test
